<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>MECS Cyber Exposure</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=Oswald:wght@500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --c-bg: #050505;
            --c-card: #0f0f0f;
            --c-border: #1a1a1a;
            --c-text: #d0d0d0;
            --c-red: #ff0038;
            --c-pink: #ff3399;
        }
        body { 
            background-color: var(--c-bg); 
            color: var(--c-text); 
            font-family: 'Inter', sans-serif;
            font-size: 0.8rem;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .navbar { background-color: var(--c-bg); border-bottom: 1px solid var(--c-border); padding: 0.4rem 1.5rem; }
        .navbar-brand { font-family: 'Oswald', sans-serif; color: white !important; font-size: 1rem; text-transform: uppercase; }
        .btn-logout { color: #666; font-size: 0.7rem; text-decoration: none; transition: 0.3s; margin-left: 15px; }
        .btn-logout:hover { color: var(--c-red); }

        .stat-card { background-color: var(--c-card); border: 1px solid var(--c-border); padding: 1rem; height: 100%; }
        .stat-card h3 { font-family: 'Oswald', sans-serif; font-size: 1.8rem; margin: 0; line-height: 1; color: white; }
        .stat-label { color: #555; text-transform: uppercase; font-size: 0.65rem; letter-spacing: 0.5px; margin-top: 5px; font-weight: 600; }
        .text-red { color: var(--c-red) !important; }
        .text-pink { color: var(--c-pink) !important; }

        .btn-action { background: linear-gradient(90deg, var(--c-red), var(--c-pink)); color: white; border: none; font-weight: 500; padding: 5px 12px; text-transform: uppercase; font-size: 0.7rem; border-radius: 2px; }
        .btn-action:hover { color: white; opacity: 0.9; }

        .table-custom { color: #ccc; margin-top: 0.5rem; font-size: 0.75rem; }
        .table-custom th { background-color: var(--c-card); color: #666; border-bottom: 1px solid var(--c-border); font-weight: 500; text-transform: uppercase; font-size: 0.65rem; padding: 8px; }
        .table-custom td { background-color: transparent; border-bottom: 1px solid var(--c-border); padding: 8px; vertical-align: middle; }
        
        .badge-risk { font-size: 0.65rem; padding: 2px 6px; border-radius: 2px; font-weight: 600; }
        .bg-crit { background-color: var(--c-red); color: white; }
        .bg-high { background-color: var(--c-pink); color: black; }
        .bg-med { background-color: #222; color: white; border: 1px solid #444; }

        .footer { text-align: center; padding: 10px; margin-top: auto; opacity: 0.1; }
        .brand-footer { font-family: 'Oswald', sans-serif; font-size: 0.7rem; color: #555; letter-spacing: 1px; }

        .modal-content { background-color: var(--c-card); border: 1px solid #333; }
        .modal-header { border-bottom: 1px solid #222; padding: 8px 15px; }
        .modal-title { font-size: 0.9rem; color: white; font-family: 'Oswald'; }
        .form-control, .form-select { background-color: #050505; border: 1px solid #333; color: white; font-size: 0.75rem; }
        .form-control:focus, .form-select:focus { background-color: #000; border-color: var(--c-pink); color: white; box-shadow: none; }
    </style>
</head>
<body>
    <nav class="navbar d-flex justify-content-between align-items-center">
        <span class="navbar-brand">SME Cyber Exposure</span>
        <div><span class="small text-muted me-2" style="font-size:0.7rem;">User: {{ user.username }}</span><a href="/logout" class="btn-logout">LOGOUT</a></div>
    </nav>
    <div class="container-fluid p-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <div><h2 style="font-family: 'Oswald'; font-size: 1.2rem; text-transform: uppercase; margin:0; color:white;">System Overview</h2></div>
            <div><a href="/report" class="btn btn-outline-secondary btn-sm me-2" style="font-size: 0.7rem; border-color: #333; color: #aaa; border-radius: 2px;">Report</a><button class="btn-action" data-bs-toggle="modal" data-bs-target="#addAssetModal"><i class="fas fa-plus me-1"></i> Add Asset</button></div>
        </div>
        <div class="row mb-3 g-2">
            <div class="col-md-3"><div class="stat-card"><h3>{{ kpis.total }}</h3><div class="stat-label">Total Assets</div></div></div>
            <div class="col-md-3"><div class="stat-card"><h3 class="text-red">{{ kpis.high_risk }}</h3><div class="stat-label">Critical Assets</div></div></div>
            <div class="col-md-3"><div class="stat-card"><h3 class="{{ 'text-pink' if kpis.avg > 50 else 'text-white' }}">{{ kpis.avg }}</h3><div class="stat-label">Avg Risk Score</div></div></div>
            <div class="col-md-3"><div class="stat-card d-flex align-items-center justify-content-between p-2"><div class="ps-2"><div class="stat-label mb-1">Risk Levels</div><small class="text-muted" style="font-size:0.65rem;">Assets Breakdown</small></div><div style="width: 55px; height: 55px;"><canvas id="miniChart"></canvas></div></div></div>
        </div>
        <div class="row g-3">
            <div class="col-lg-8"><div style="background: var(--c-card); border: 1px solid var(--c-border); padding: 15px;"><h6 class="text-uppercase mb-0" style="font-family: 'Oswald'; font-size: 0.8rem; color:white;">Infrastructure Status</h6><div class="table-responsive"><table class="table table-custom mb-0"><thead><tr><th>Asset Name</th><th>IP Address</th><th>Risk Score</th><th>Active Threat</th><th></th></tr></thead><tbody>{% for asset in assets %}<tr><td class="fw-bold text-white">{{ asset.name }}</td><td>{{ asset.ip_address }}</td><td><div class="d-flex align-items-center"><span class="me-2" style="width:20px; color: {{ '#ff0038' if asset.risk_score >= 75 else '#ff3399' if asset.risk_score >= 50 else '#ccc' }}">{{ asset.risk_score }}</span><div class="progress" style="height: 3px; background-color: #222; width: 60px;"><div class="progress-bar" role="progressbar" style="width: {{ asset.risk_score }}%; background-color: {{ '#ff0038' if asset.risk_score >= 75 else '#ff3399' if asset.risk_score >= 50 else '#fff' }}"></div></div></div></td><td>{% if asset.vulns %}<span class="badge-risk {{ 'bg-crit' if asset.vulns[0].severity == 'Critical' else 'bg-high' if asset.vulns[0].severity == 'High' else 'bg-med' }}">{{ asset.vulns[0].cve_id }}</span>{% else %}<span class="text-muted" style="font-size: 0.65rem;">Secure</span>{% endif %}</td><td class="text-end"><a href="/scan/{{ asset.id }}" class="text-secondary hover-white"><i class="fas fa-sync-alt small"></i></a></td></tr>{% endfor %}</tbody></table></div></div></div>
            <div class="col-lg-4"><div style="background: var(--c-card); border: 1px solid var(--c-border); padding: 15px; height: 100%;"><h6 class="text-uppercase mb-3" style="font-family: 'Oswald'; font-size: 0.8rem; color:white;">Audit Trail</h6>{% for log in logs %}<div class="mb-2 pb-2 border-bottom border-secondary" style="border-color: #222 !important;"><small class="text-pink" style="font-size: 0.65rem;">{{ log.timestamp.strftime('%H:%M') }}</small><div style="font-size: 0.75rem; color: #ccc;">{{ log.action }}</div></div>{% endfor %}</div></div>
        </div>
    </div>
    <footer class="footer"><div class="brand-footer">#MECS</div></footer>
    <div class="modal fade" id="addAssetModal" tabindex="-1"><div class="modal-dialog modal-sm"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">New Asset</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><form action="/add_asset" method="POST"><div class="modal-body"><input type="text" name="name" class="form-control mb-2" placeholder="Asset Name" required><input type="text" name="ip" class="form-control mb-2" placeholder="IP Address" required><select name="os_type" class="form-select mb-2"><option value="Windows">Windows</option><option value="Linux">Linux</option></select><select name="role" class="form-select"><option value="Server">Server</option><option value="Workstation">Workstation</option></select></div><div class="modal-footer p-2"><button type="submit" class="btn-action w-100">Add & Scan</button></div></form></div></div></div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const ctx = document.getElementById('miniChart').getContext('2d');
        const chartData = {{ chart_data | tojson }};
        new Chart(ctx, { type: 'doughnut', data: { labels: ['Critical', 'High', 'Med', 'Low'], datasets: [{ data: [chartData['Critical'], chartData['High'], chartData['Medium'], chartData['Low']], backgroundColor: ['#ff0038', '#ff3399', '#ffffff', '#222'], borderWidth: 0 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, cutout: '75%' } });
    </script>
</body>
</html>
